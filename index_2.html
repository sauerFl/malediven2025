
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Geschützter Zugriff über NFT</title>
</head>
<body>
  <h1>Zugriffsschutz per NFT</h1>
  <p>Die Datei auf Arweave wird entschlüsselt, wenn du den richtigen NFT besitzt.</p>

  <script type="module">
    import LitJsSdk from 'https://cdn.jsdelivr.net/npm/@lit-protocol/lit-browser-sdk@2.0.4/+esm';

    const client = new LitJsSdk.LitNodeClient({ litNetwork: "datil" });
    await client.connect();

    const authSig = await LitJsSdk.checkAndSignAuthMessage({ chain: "polygon" });

    const accessControlConditions = [
      {
        contractAddress: "0x20e8640f1b32bee9496f71ccfe74977d01ae52c1",
        standardContractType: "ERC721",
        chain: "polygon",
        method: "ownerOf",
        parameters: ["1"],
        returnValueTest: {
          comparator: "=",
          value: ":userAddress"
        }
      }
    ];

    const response = await fetch("https://arweave.net/ajtB17K5rjPUJgUYrVxoBM_S6nC-J20ShVgKbS7EuSA");
    const encryptedBlob = await response.blob();
    const encryptedArrayBuffer = await encryptedBlob.arrayBuffer();

    const encryptedSymmetricKeyHex = prompt("Füge hier den verschlüsselten AES-Schlüssel (Hex) ein:");
    const encryptedSymmetricKey = new Uint8Array(encryptedSymmetricKeyHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

    const symmetricKey = await client.getEncryptionKey({
      unifiedAccessControlConditions: accessControlConditions,
      toDecrypt: LitJsSdk.uint8arrayToString(encryptedSymmetricKey, "base16"),
      chain: "polygon",
      authSig
    });

    const ivBase64 = prompt("Füge hier die IV aus lit_key_meta.json ein (Base64):");
    const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));

    const cryptoKey = await crypto.subtle.importKey(
      "raw",
      symmetricKey,
      { name: "AES-CBC" },
      false,
      ["decrypt"]
    );

    const decrypted = await crypto.subtle.decrypt(
      { name: "AES-CBC", iv },
      cryptoKey,
      encryptedArrayBuffer
    );

    const blob = new Blob([decrypted]);
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = "entschluesselt.jpg";
    link.textContent = "⬇️ Entschlüsselte Datei herunterladen";
    document.body.appendChild(link);
  </script>
</body>
</html>
