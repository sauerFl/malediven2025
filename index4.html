
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Index4 â€“ QR-basierte EntschlÃ¼sselung (sichtbare Felder)</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4faff; padding: 2em; text-align: center; }
    button, input { margin-top: 1em; padding: 0.6em; width: 90%; max-width: 500px; }
    .file-entry { margin-top: 2em; }
    img.preview { max-width: 90%; margin-top: 1em; border: 1px solid #ccc; }
    #qr-reader { width: 300px; margin: 2em auto; display: none; }
    textarea { width: 90%; height: 120px; margin-top: 1em; font-family: monospace; }
  </style>
</head>
<body>
  <h1>ðŸ“· QR-only EntschlÃ¼sselung + Werte anzeigen</h1>
  <button id="startScan">ðŸ“· QR-Code scannen</button>
  <div id="qr-reader"></div>

  <input id="manifestField" placeholder="Manifest-ID (aus Pfad)" readonly /><br>
  <input id="keyField" placeholder="AES-Key (Base64)" readonly /><br>
  <input id="ivField" placeholder="IV (Base64)" readonly /><br>

  <div id="output"></div>

  <script>
    document.getElementById("startScan").addEventListener("click", () => {
      const reader = new Html5Qrcode("qr-reader");
      document.getElementById("qr-reader").style.display = "block";

      reader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText, result) => {
          try {
            const data = JSON.parse(decodedText);
            reader.stop();
            document.getElementById("qr-reader").style.display = "none";

            const keyBase64 = data.key;
            const ivBase64 = data.iv;
            const manifestPaths = data.manifest.paths;

            const output = document.getElementById("output");
            output.innerHTML = "<h3>EntschlÃ¼sselungsergebnisse:</h3>";

            const keyBytes = Uint8Array.from(atob(keyBase64), c => c.charCodeAt(0));
            const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));

            // Trage erste Manifest-TX-ID ins Feld ein
            const firstId = Object.values(manifestPaths)[0]?.id || "";
            document.getElementById("manifestField").value = firstId;
            document.getElementById("keyField").value = keyBase64;
            document.getElementById("ivField").value = ivBase64;

            const cryptoKey = await crypto.subtle.importKey(
              "raw",
              keyBytes,
              { name: "AES-CBC" },
              false,
              ["decrypt"]
            );

            for (const [name, info] of Object.entries(manifestPaths)) {
              const fileUrl = `https://arweave.net/${info.id}`;
              const entry = document.createElement("div");
              entry.className = "file-entry";
              entry.innerHTML = `<strong>${name}</strong><br>Lade...`;
              output.appendChild(entry);

              try {
                const res = await fetch(fileUrl);
                const encryptedBuffer = await res.arrayBuffer();

                const decrypted = await crypto.subtle.decrypt(
                  { name: "AES-CBC", iv },
                  cryptoKey,
                  encryptedBuffer
                );

                const blob = new Blob([decrypted]);
                const url = URL.createObjectURL(blob);

                const img = document.createElement("img");
                img.src = url;
                img.alt = name;
                img.className = "preview";

                entry.innerHTML = `<strong>${name}</strong><br>`;
                entry.appendChild(img);
              } catch (err) {
                entry.innerHTML += "<br>âŒ EntschlÃ¼sselung fehlgeschlagen.";
                console.error(err);
              }
            }

          } catch (e) {
            alert("âŒ UngÃ¼ltiger QR-Inhalt");
            console.error(e);
          }
        },
        (error) => { /* Ignorieren */ }
      );
    });
  </script>
</body>
</html>
